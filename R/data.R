source(paste0("R/Flu_Exposure.R"))

normalit<-function(m){
  (m - min(m))/(max(m)-min(m))
}

datagrippe_com <- datagrippe %>%
  select(Cases.rollsum, Cases.range, weeks.range)

# 
databern <- read.csv(paste0("data_raw/",data.bern), header=TRUE, sep=";") %>%
  filter(!(gest <30)) %>%
  filter(!year=="1901") %>%
  filter(!year=="1923") %>%
  select(year, insurance, matage, married,parity, gest, birthday2, boy, stillborn, multiple, weight, gestdummy2, matheight2, matbody2,
         malnutrition2, occupation2, agemenarche, coordinates, distance, city, Grippe) %>%
  mutate(coordinates=ifelse(coordinates=="", NA, coordinates),
         birth_isoweek = isoweek(dmy(birthday2)),
         birth_month = month(dmy(birthday2)),
         birth_season = as.character(cut(birth_month, breaks=c(1,3,6,9,12),include.lowest = TRUE)),
         birth_season  = replace(birth_season, birth_season=="[1,3]", "Winter" ),
         birth_season  = replace(birth_season, birth_season=="(3,6]", "Spring" ),
         birth_season  = replace(birth_season, birth_season=="(6,9]", "Summer" ),
         birth_season  = replace(birth_season, birth_season=="(9,12]", "Fall" ),
         birth_season = as.factor(birth_season),
         birth_season = factor(birth_season, levels = c("Spring","Summer","Fall","Winter")),
         gest = ifelse(gest >42, 42, gest),
         Gest_group = floor(gest),
         Gest_group  = replace(Gest_group ,Gest_group>=38, "normal" ),
         Gest_group  = replace(Gest_group ,Gest_group<38, "early" ),
         Gest_group = as.factor(Gest_group),
         Gest_tri = round(gest,0)-26,
         parity = ifelse(parity>3, 4, parity),
         parity = as.factor(parity),
         parity = ifelse(parity=="4",">=4", parity),
         parity = factor(parity, levels = c("1","2","3",">=4")),
         First.Trimester = dmy(birthday2) - round(gest*7,0),
         First.Trimester.isoweek = isoweek(ymd(First.Trimester)),
         First.Trimester.year = year(First.Trimester),
         First.Trimester.weeks.range = paste0(First.Trimester.isoweek,"_", First.Trimester.isoweek+12,"_",First.Trimester.year),
         Second.Trimester = First.Trimester + 13*7,
         Second.Trimester.year = year(Second.Trimester),
         Second.Trimester.isoweek = isoweek(ymd(Second.Trimester)),
         Second.Trimester.weeks.range = paste0(Second.Trimester.isoweek,"_", Second.Trimester.isoweek+12,"_",Second.Trimester.year),
         Third.Trimester = Second.Trimester + Gest_tri*7,
         Third.Trimester.year = year(Third.Trimester),
         Third.Trimester.isoweek = isoweek(ymd(Third.Trimester)),
         Third.Trimester.weeks.range = paste0(Third.Trimester.isoweek,"_", Third.Trimester.isoweek+Gest_tri-1,"_",Third.Trimester.year),
         Spanishflu = ifelse(year==1918 | year==1919, 1,0),
         id= 1:nrow(.),
         First.Trimester.weeks.range = replace(First.Trimester.weeks.range,First.Trimester.weeks.range=="41_53_1918", "41_1_1919"),
         First.Trimester.weeks.range = replace(First.Trimester.weeks.range,First.Trimester.weeks.range=="42_54_1918", "42_2_1919"),
         First.Trimester.weeks.range = replace(First.Trimester.weeks.range,First.Trimester.weeks.range=="43_55_1918", "43_3_1919"),
         First.Trimester.weeks.range = replace(First.Trimester.weeks.range,First.Trimester.weeks.range=="44_56_1918", "44_4_1919"),
         First.Trimester.weeks.range = replace(First.Trimester.weeks.range,First.Trimester.weeks.range=="45_57_1918", "45_5_1919"),
         First.Trimester.weeks.range = replace(First.Trimester.weeks.range,First.Trimester.weeks.range=="46_58_1918", "46_6_1919"),
         First.Trimester.weeks.range = replace(First.Trimester.weeks.range,First.Trimester.weeks.range=="47_59_1918", "47_7_1919"),
         First.Trimester.weeks.range = replace(First.Trimester.weeks.range,First.Trimester.weeks.range=="48_60_1918", "48_8_1919"),
         First.Trimester.weeks.range = replace(First.Trimester.weeks.range,First.Trimester.weeks.range=="49_61_1918", "49_9_1919"),
         First.Trimester.weeks.range = replace(First.Trimester.weeks.range,First.Trimester.weeks.range=="50_62_1918", "50_10_1919"),
         First.Trimester.weeks.range = replace(First.Trimester.weeks.range,First.Trimester.weeks.range=="51_63_1918", "51_11_1919"),
         First.Trimester.weeks.range = replace(First.Trimester.weeks.range,First.Trimester.weeks.range=="52_64_1918", "52_12_1919"),
         Second.Trimester.weeks.range = replace(Second.Trimester.weeks.range,Second.Trimester.weeks.range=="41_53_1918", "41_1_1919"),
         Second.Trimester.weeks.range = replace(Second.Trimester.weeks.range,Second.Trimester.weeks.range=="42_54_1918", "42_2_1919"),
         Second.Trimester.weeks.range = replace(Second.Trimester.weeks.range,Second.Trimester.weeks.range=="43_55_1918", "43_3_1919"),
         Second.Trimester.weeks.range = replace(Second.Trimester.weeks.range,Second.Trimester.weeks.range=="44_56_1918", "44_4_1919"),
         Second.Trimester.weeks.range = replace(Second.Trimester.weeks.range,Second.Trimester.weeks.range=="45_57_1918", "45_5_1919"),
         Second.Trimester.weeks.range = replace(Second.Trimester.weeks.range,Second.Trimester.weeks.range=="46_58_1918", "46_6_1919"),
         Second.Trimester.weeks.range = replace(Second.Trimester.weeks.range,Second.Trimester.weeks.range=="47_59_1918", "47_7_1919"),
         Second.Trimester.weeks.range = replace(Second.Trimester.weeks.range,Second.Trimester.weeks.range=="48_60_1918", "48_8_1919"),
         Second.Trimester.weeks.range = replace(Second.Trimester.weeks.range,Second.Trimester.weeks.range=="49_61_1918", "49_9_1919"),
         Second.Trimester.weeks.range = replace(Second.Trimester.weeks.range,Second.Trimester.weeks.range=="50_62_1918", "50_10_1919"),
         Second.Trimester.weeks.range = replace(Second.Trimester.weeks.range,Second.Trimester.weeks.range=="51_63_1918", "51_11_1919"),
         Second.Trimester.weeks.range = replace(Second.Trimester.weeks.range,Second.Trimester.weeks.range=="52_64_1918", "52_12_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="38_53_1918", "38_1_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="39_53_1918", "39_1_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="39_54_1918", "39_2_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="40_53_1918", "40_1_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="40_54_1918", "40_2_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="40_55_1918", "40_3_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="41_53_1918", "41_1_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="41_54_1918", "41_2_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="41_55_1918", "41_3_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="41_56_1918", "41_4_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="42_53_1918", "42_1_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="42_54_1918", "42_2_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="42_55_1918", "42_3_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="42_56_1918", "42_4_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="42_57_1918", "42_5_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="42_58_1918", "42_6_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="43_53_1918", "43_1_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="43_54_1918", "43_2_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="43_55_1918", "43_3_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="43_56_1918", "43_4_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="43_57_1918", "43_5_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="43_58_1918", "43_6_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="43_59_1918", "43_7_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="44_53_1918", "44_1_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="44_54_1918", "44_2_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="44_55_1918", "44_3_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="44_56_1918", "44_4_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="44_57_1918", "44_5_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="44_58_1918", "44_6_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="44_59_1918", "44_7_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="44_60_1918", "44_8_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="45_53_1918", "45_1_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="45_54_1918", "45_2_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="45_55_1918", "45_3_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="45_56_1918", "45_4_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="45_57_1918", "45_5_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="45_58_1918", "45_6_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="45_59_1918", "45_7_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="45_60_1918", "45_8_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="45_61_1918", "45_9_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="46_53_1918", "46_1_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="46_54_1918", "46_2_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="46_55_1918", "46_3_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="46_56_1918", "46_4_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="46_57_1918", "46_5_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="46_58_1918", "46_6_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="46_59_1918", "46_7_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="46_60_1918", "46_8_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="46_61_1918", "46_9_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="46_62_1918", "46_10_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="47_53_1918", "47_1_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="47_54_1918", "47_2_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="47_55_1918", "47_3_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="47_56_1918", "47_4_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="47_57_1918", "47_5_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="47_58_1918", "47_6_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="47_59_1918", "47_7_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="47_60_1918", "47_8_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="47_61_1918", "47_9_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="47_62_1918", "47_10_1919"),   
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="47_63_1918", "47_11_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="48_53_1918", "48_1_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="48_54_1918", "48_2_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="48_55_1918", "48_3_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="48_56_1918", "48_4_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="48_57_1918", "48_5_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="48_58_1918", "48_6_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="48_59_1918", "48_7_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="48_60_1918", "48_8_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="48_61_1918", "48_9_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="48_62_1918", "48_10_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="48_63_1918", "48_11_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="48_64_1918", "48_12_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="49_53_1918", "49_1_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="49_54_1918", "49_2_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="49_55_1918", "49_3_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="49_56_1918", "49_4_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="49_57_1918", "49_5_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="49_58_1918", "49_6_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="49_59_1918", "49_7_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="49_60_1918", "49_8_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="49_61_1918", "49_9_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="49_62_1918", "49_10_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="49_63_1918", "49_11_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="49_64_1918", "49_12_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="49_65_1918", "49_13_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="50_53_1918", "50_1_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="50_54_1918", "50_2_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="50_55_1918", "50_3_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="50_56_1918", "50_4_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="50_57_1918", "50_5_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="50_58_1918", "50_6_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="50_59_1918", "50_7_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="50_60_1918", "50_8_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="50_61_1918", "50_9_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="50_62_1918", "50_10_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="50_63_1918", "50_11_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="50_64_1918", "50_12_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="50_65_1918", "50_13_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="50_66_1918", "50_14_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="51_53_1918", "51_1_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="51_54_1918", "51_2_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="51_55_1918", "51_3_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="51_56_1918", "51_4_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="51_57_1918", "51_5_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="51_58_1918", "51_6_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="51_59_1918", "51_7_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="51_60_1918", "51_8_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="51_61_1918", "51_9_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="51_62_1918", "51_10_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="51_63_1918", "51_11_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="51_64_1918", "51_12_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="51_65_1918", "51_13_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="51_66_1918", "51_14_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="51_67_1918", "51_15_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="52_53_1918", "52_1_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="52_54_1918", "52_2_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="52_55_1918", "52_3_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="52_56_1918", "52_4_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="52_57_1918", "52_5_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="52_58_1918", "52_6_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="52_59_1918", "52_7_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="52_60_1918", "52_8_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="52_61_1918", "52_9_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="52_62_1918", "52_10_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="52_63_1918", "52_11_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="52_64_1918", "52_12_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="52_65_1918", "52_13_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="52_66_1918", "52_14_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="52_67_1918", "52_15_1919"),
         Third.Trimester.weeks.range = replace(Third.Trimester.weeks.range,Third.Trimester.weeks.range=="52_68_1918", "52_16_1919"),
         Third.Trimester.weeks.range = ifelse(Third.Trimester=="1918-12-30" & Gest_tri==11 ,"1_11_1919", Third.Trimester.weeks.range),
         Third.Trimester.weeks.range = ifelse(Third.Trimester=="1918-12-31" & Gest_tri==12 ,"1_12_1919", Third.Trimester.weeks.range),
         Third.Trimester.weeks.range = ifelse(Third.Trimester=="1918-12-31" & Gest_tri==16 ,"1_16_1919", Third.Trimester.weeks.range),
         Third.Trimester.weeks.range = ifelse(Third.Trimester=="1918-12-30" & Gest_tri==16 ,"1_16_1919", Third.Trimester.weeks.range),
         Third.Trimester.weeks.range = ifelse(Third.Trimester=="1919-12-29" & Gest_tri==16 ,"1_16_1920", Third.Trimester.weeks.range),
         Third.Trimester.weeks.range = ifelse(Third.Trimester=="1918-12-31"  & Gest_tri==16 ,"1_16_1919", Third.Trimester.weeks.range),
         Third.Trimester.weeks.range = ifelse(Third.Trimester=="1919-12-31"  & Gest_tri==16 ,"1_16_1920", Third.Trimester.weeks.range),
         First.Trimester.weeks.range = ifelse(First.Trimester=="1919-12-29","1_13_1920", First.Trimester.weeks.range))
         
                                              
    
databern_first <- databern %>%
  select(weeks.range=First.Trimester.weeks.range, id) %>%
  left_join(datagrippe_com) %>%
  rename(Cases.rollsum.first = Cases.rollsum,
         Cases.range.first = Cases.range) %>%
           select(-weeks.range)
         
databern_second <- databern %>%
  select(weeks.range=Second.Trimester.weeks.range, id) %>%
  left_join(datagrippe_com) %>%
  rename(Cases.rollsum.second = Cases.rollsum,
         Cases.range.second = Cases.range) %>%
  select(-weeks.range)

databern_third <- databern %>%
  select(weeks.range=Third.Trimester.weeks.range, id) %>%
  mutate(
    weeks.range = replace(weeks.range,weeks.range=="38_53_1918", "38_1_1919"),
    weeks.range = replace(weeks.range,weeks.range=="39_53_1918", "39_1_1919"),
    weeks.range = replace(weeks.range,weeks.range=="39_54_1918", "39_2_1919"),
    weeks.range = replace(weeks.range,weeks.range=="40_53_1918", "40_1_1919"),
    weeks.range = replace(weeks.range,weeks.range=="40_54_1918", "40_2_1919"),
    weeks.range = replace(weeks.range,weeks.range=="40_55_1918", "40_3_1919"),
    weeks.range = replace(weeks.range,weeks.range=="41_53_1918", "41_1_1919"),
    weeks.range = replace(weeks.range,weeks.range=="41_54_1918", "41_2_1919"),
    weeks.range = replace(weeks.range,weeks.range=="41_55_1918", "41_3_1919"),
    weeks.range = replace(weeks.range,weeks.range=="41_56_1918", "41_4_1919"),
    weeks.range = replace(weeks.range,weeks.range=="42_53_1918", "42_1_1919"),
    weeks.range = replace(weeks.range,weeks.range=="42_54_1918", "42_2_1919"),
    weeks.range = replace(weeks.range,weeks.range=="42_55_1918", "42_3_1919"),
    weeks.range = replace(weeks.range,weeks.range=="42_56_1918", "42_4_1919"),
    weeks.range = replace(weeks.range,weeks.range=="42_57_1918", "42_5_1919"),
    weeks.range = replace(weeks.range,weeks.range=="42_58_1918", "42_6_1919"),
    weeks.range = replace(weeks.range,weeks.range=="43_53_1918", "43_1_1919"),
    weeks.range = replace(weeks.range,weeks.range=="43_54_1918", "43_2_1919"),
    weeks.range = replace(weeks.range,weeks.range=="43_55_1918", "43_3_1919"),
    weeks.range = replace(weeks.range,weeks.range=="43_56_1918", "43_4_1919"),
    weeks.range = replace(weeks.range,weeks.range=="43_57_1918", "43_5_1919"),
    weeks.range = replace(weeks.range,weeks.range=="43_58_1918", "43_6_1919"),
    weeks.range = replace(weeks.range,weeks.range=="43_59_1918", "43_7_1919"),
    weeks.range = replace(weeks.range,weeks.range=="44_53_1918", "44_1_1919"),
    weeks.range = replace(weeks.range,weeks.range=="44_54_1918", "44_2_1919"),
    weeks.range = replace(weeks.range,weeks.range=="44_55_1918", "44_3_1919"),
    weeks.range = replace(weeks.range,weeks.range=="44_56_1918", "44_4_1919"),
    weeks.range = replace(weeks.range,weeks.range=="44_57_1918", "44_5_1919"),
    weeks.range = replace(weeks.range,weeks.range=="44_58_1918", "44_6_1919"),
    weeks.range = replace(weeks.range,weeks.range=="44_59_1918", "44_7_1919"),
    weeks.range = replace(weeks.range,weeks.range=="44_60_1918", "44_8_1919"),
    weeks.range = replace(weeks.range,weeks.range=="45_53_1918", "45_1_1919"),
    weeks.range = replace(weeks.range,weeks.range=="45_54_1918", "45_2_1919"),
    weeks.range = replace(weeks.range,weeks.range=="45_55_1918", "45_3_1919"),
    weeks.range = replace(weeks.range,weeks.range=="45_56_1918", "45_4_1919"),
    weeks.range = replace(weeks.range,weeks.range=="45_57_1918", "45_5_1919"),
    weeks.range = replace(weeks.range,weeks.range=="45_58_1918", "45_6_1919"),
    weeks.range = replace(weeks.range,weeks.range=="45_59_1918", "45_7_1919"),
    weeks.range = replace(weeks.range,weeks.range=="45_60_1918", "45_8_1919"),
    weeks.range = replace(weeks.range,weeks.range=="45_61_1918", "45_9_1919"),
    weeks.range = replace(weeks.range,weeks.range=="46_53_1918", "46_1_1919"),
    weeks.range = replace(weeks.range,weeks.range=="46_54_1918", "46_2_1919"),
    weeks.range = replace(weeks.range,weeks.range=="46_55_1918", "46_3_1919"),
    weeks.range = replace(weeks.range,weeks.range=="46_56_1918", "46_4_1919"),
    weeks.range = replace(weeks.range,weeks.range=="46_57_1918", "46_5_1919"),
    weeks.range = replace(weeks.range,weeks.range=="46_58_1918", "46_6_1919"),
    weeks.range = replace(weeks.range,weeks.range=="46_59_1918", "46_7_1919"),
    weeks.range = replace(weeks.range,weeks.range=="46_60_1918", "46_8_1919"),
    weeks.range = replace(weeks.range,weeks.range=="46_61_1918", "46_9_1919"),
    weeks.range = replace(weeks.range,weeks.range=="46_62_1918", "46_10_1919"),
    weeks.range = replace(weeks.range,weeks.range=="47_53_1918", "47_1_1919"),
    weeks.range = replace(weeks.range,weeks.range=="47_54_1918", "47_2_1919"),
    weeks.range = replace(weeks.range,weeks.range=="47_55_1918", "47_3_1919"),
    weeks.range = replace(weeks.range,weeks.range=="47_56_1918", "47_4_1919"),
    weeks.range = replace(weeks.range,weeks.range=="47_57_1918", "47_5_1919"),
    weeks.range = replace(weeks.range,weeks.range=="47_58_1918", "47_6_1919"),
    weeks.range = replace(weeks.range,weeks.range=="47_59_1918", "47_7_1919"),
    weeks.range = replace(weeks.range,weeks.range=="47_60_1918", "47_8_1919"),
    weeks.range = replace(weeks.range,weeks.range=="47_61_1918", "47_9_1919"),
    weeks.range = replace(weeks.range,weeks.range=="47_62_1918", "47_10_1919"),   
    weeks.range = replace(weeks.range,weeks.range=="47_63_1918", "47_11_1919"),
    weeks.range = replace(weeks.range,weeks.range=="48_53_1918", "48_1_1919"),
    weeks.range = replace(weeks.range,weeks.range=="48_54_1918", "48_2_1919"),
    weeks.range = replace(weeks.range,weeks.range=="48_55_1918", "48_3_1919"),
    weeks.range = replace(weeks.range,weeks.range=="48_56_1918", "48_4_1919"),
    weeks.range = replace(weeks.range,weeks.range=="48_57_1918", "48_5_1919"),
    weeks.range = replace(weeks.range,weeks.range=="48_58_1918", "48_6_1919"),
    weeks.range = replace(weeks.range,weeks.range=="48_59_1918", "48_7_1919"),
    weeks.range = replace(weeks.range,weeks.range=="48_60_1918", "48_8_1919"),
    weeks.range = replace(weeks.range,weeks.range=="48_61_1918", "48_9_1919"),
    weeks.range = replace(weeks.range,weeks.range=="48_62_1918", "48_10_1919"),
    weeks.range = replace(weeks.range,weeks.range=="48_63_1918", "48_11_1919"),
    weeks.range = replace(weeks.range,weeks.range=="48_64_1918", "48_12_1919"),
    weeks.range = replace(weeks.range,weeks.range=="49_53_1918", "49_1_1919"),
    weeks.range = replace(weeks.range,weeks.range=="49_54_1918", "49_2_1919"),
    weeks.range = replace(weeks.range,weeks.range=="49_55_1918", "49_3_1919"),
    weeks.range = replace(weeks.range,weeks.range=="49_56_1918", "49_4_1919"),
    weeks.range = replace(weeks.range,weeks.range=="49_57_1918", "49_5_1919"),
    weeks.range = replace(weeks.range,weeks.range=="49_58_1918", "49_6_1919"),
    weeks.range = replace(weeks.range,weeks.range=="49_59_1918", "49_7_1919"),
    weeks.range = replace(weeks.range,weeks.range=="49_60_1918", "49_8_1919"),
    weeks.range = replace(weeks.range,weeks.range=="49_61_1918", "49_9_1919"),
    weeks.range = replace(weeks.range,weeks.range=="49_62_1918", "49_10_1919"),
    weeks.range = replace(weeks.range,weeks.range=="49_63_1918", "49_11_1919"),
    weeks.range = replace(weeks.range,weeks.range=="49_64_1918", "49_12_1919"),
    weeks.range = replace(weeks.range,weeks.range=="49_65_1918", "49_13_1919"),
    weeks.range = replace(weeks.range,weeks.range=="50_53_1918", "50_1_1919"),
    weeks.range = replace(weeks.range,weeks.range=="50_54_1918", "50_2_1919"),
    weeks.range = replace(weeks.range,weeks.range=="50_55_1918", "50_3_1919"),
    weeks.range = replace(weeks.range,weeks.range=="50_56_1918", "50_4_1919"),
    weeks.range = replace(weeks.range,weeks.range=="50_57_1918", "50_5_1919"),
    weeks.range = replace(weeks.range,weeks.range=="50_58_1918", "50_6_1919"),
    weeks.range = replace(weeks.range,weeks.range=="50_59_1918", "50_7_1919"),
    weeks.range = replace(weeks.range,weeks.range=="50_60_1918", "50_8_1919"),
    weeks.range = replace(weeks.range,weeks.range=="50_61_1918", "50_9_1919"),
    weeks.range = replace(weeks.range,weeks.range=="50_62_1918", "50_10_1919"),
    weeks.range = replace(weeks.range,weeks.range=="50_63_1918", "50_11_1919"),
    weeks.range = replace(weeks.range,weeks.range=="50_64_1918", "50_12_1919"),
    weeks.range = replace(weeks.range,weeks.range=="50_65_1918", "50_13_1919"),
    weeks.range = replace(weeks.range,weeks.range=="50_66_1918", "50_14_1919"),
    weeks.range = replace(weeks.range,weeks.range=="51_53_1918", "51_1_1919"),
    weeks.range = replace(weeks.range,weeks.range=="51_54_1918", "51_2_1919"),
    weeks.range = replace(weeks.range,weeks.range=="51_55_1918", "51_3_1919"),
    weeks.range = replace(weeks.range,weeks.range=="51_56_1918", "51_4_1919"),
    weeks.range = replace(weeks.range,weeks.range=="51_57_1918", "51_5_1919"),
    weeks.range = replace(weeks.range,weeks.range=="51_58_1918", "51_6_1919"),
    weeks.range = replace(weeks.range,weeks.range=="51_59_1918", "51_7_1919"),
    weeks.range = replace(weeks.range,weeks.range=="51_60_1918", "51_8_1919"),
    weeks.range = replace(weeks.range,weeks.range=="51_61_1918", "51_9_1919"),
    weeks.range = replace(weeks.range,weeks.range=="51_62_1918", "51_10_1919"),
    weeks.range = replace(weeks.range,weeks.range=="51_63_1918", "51_11_1919"),
    weeks.range = replace(weeks.range,weeks.range=="51_64_1918", "51_12_1919"),
    weeks.range = replace(weeks.range,weeks.range=="51_65_1918", "51_13_1919"),
    weeks.range = replace(weeks.range,weeks.range=="51_66_1918", "51_14_1919"),
    weeks.range = replace(weeks.range,weeks.range=="51_67_1918", "51_15_1919"),
    weeks.range = replace(weeks.range,weeks.range=="52_53_1918", "52_1_1919"),
    weeks.range = replace(weeks.range,weeks.range=="52_54_1918", "52_2_1919"),
    weeks.range = replace(weeks.range,weeks.range=="52_55_1918", "52_3_1919"),
    weeks.range = replace(weeks.range,weeks.range=="52_56_1918", "52_4_1919"),
    weeks.range = replace(weeks.range,weeks.range=="52_57_1918", "52_5_1919"),
    weeks.range = replace(weeks.range,weeks.range=="52_58_1918", "52_6_1919"),
    weeks.range = replace(weeks.range,weeks.range=="52_59_1918", "52_7_1919"),
    weeks.range = replace(weeks.range,weeks.range=="52_60_1918", "52_8_1919"),
    weeks.range = replace(weeks.range,weeks.range=="52_61_1918", "52_9_1919"),
    weeks.range = replace(weeks.range,weeks.range=="52_62_1918", "52_10_1919"),
    weeks.range = replace(weeks.range,weeks.range=="52_63_1918", "52_11_1919"),
    weeks.range = replace(weeks.range,weeks.range=="52_64_1918", "52_12_1919"),
    weeks.range = replace(weeks.range,weeks.range=="52_65_1918", "52_13_1919"),
    weeks.range = replace(weeks.range,weeks.range=="52_66_1918", "52_14_1919"),
    weeks.range = replace(weeks.range,weeks.range=="52_67_1918", "52_15_1919"),
    weeks.range = replace(weeks.range,weeks.range=="52_68_1918", "52_16_1919")) %>%
left_join(datagrippe_com) %>%
  rename(Cases.rollsum.third = Cases.rollsum,
         Cases.range.third = Cases.range) %>%
           select(-weeks.range)


databern_tri <- databern_first %>%
  inner_join(databern_second ) %>%
  inner_join(databern_third)

databern <- databern %>%
  left_join(databern_tri) %>%
  mutate(Cases.rollsum.first=ifelse(is.na(Cases.rollsum.first),0, Cases.rollsum.first),
         Cases.rollsum.second=ifelse(is.na(Cases.rollsum.second),0, Cases.rollsum.second),
         Cases.rollsum.third=ifelse(is.na(Cases.rollsum.third),0, Cases.rollsum.third),
         Cases.rollsum.all = Cases.rollsum.first+ Cases.rollsum.second+ Cases.rollsum.third,
         Flu_intensity_all = round(normalit( Cases.rollsum.all),2),
         Flu_intensity_first=ifelse(is.na(Cases.range.first),0, Cases.range.first),
         Flu_intensity_second=ifelse(is.na(Cases.range.second),0, Cases.range.second),
         Flu_intensity_third=ifelse(is.na(Cases.range.third),0, Cases.range.third),
         Exposure_first=ifelse( Cases.rollsum.first>0,1,0),
         Exposure_first=ifelse(is.na(Exposure_first),0, Exposure_first),
         Exposure_second=ifelse(Cases.rollsum.second>0,1,0),
         Exposure_second=ifelse(is.na(Exposure_second),0, Exposure_second),
         Exposure_third=ifelse(Cases.rollsum.third>0,1,0),
         Exposure_third=ifelse(is.na(Exposure_third),0, Exposure_third),
         Exposure_sum =  Exposure_first+Exposure_second+ Exposure_third,
         Exposure_sum =  ifelse(is.na(Exposure_sum),0, Exposure_sum),
         Exposure_sum_dummy = ifelse(Exposure_sum >0,1,0)) %>%
  select(-First.Trimester.isoweek,-Second.Trimester.isoweek, -Third.Trimester.isoweek)

save(databern,file=paste0("data/databern.RData"))
write.table(databern,file=paste0("data/databern.csv"),row.names=FALSE, sep=";")
